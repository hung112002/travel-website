<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒã‚¤ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« | Shimane Travel</title>
    <link rel="stylesheet" href="/css/auth-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <% const favoritesSafe = (typeof favorites !== 'undefined' && favorites) ? favorites : []; %>

    <div class="auth-wrapper">
        <div class="luxury-card" style="max-width: 900px; display: flex; gap: 40px; flex-wrap: wrap; padding: 40px;">
            
            <div style="flex: 1; min-width: 250px; border-right: 1px solid #eee; padding-right: 20px; text-align: center;">
                <div style="font-size: 80px; margin-bottom: 10px;">ğŸ‘¤</div>
                <h2 style="font-family: 'Noto Serif JP'; color: var(--primary);"><%= user.username %></h2>
                <p style="background: var(--accent); color: white; display: inline-block; padding: 2px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-bottom: 20px;">
                    <%= user.role.toUpperCase() %>
                </p>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #eee;">
                    <span style="font-size: 2rem; font-weight: 700; color: var(--primary);"><%= favoritesSafe.length %></span>
                    <p style="font-size: 0.8rem; color: #666; margin-top: 5px; font-weight: bold;">ãŠæ°—ã«å…¥ã‚Šã‚¹ãƒãƒƒãƒˆ</p>
                    <p style="font-size: 0.7rem; color: #999;">(Äá»‹a Ä‘iá»ƒm Ä‘Ã£ lÆ°u)</p>
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <% if (user && user.role === 'admin') { %>
                        <a href="/admin" class="btn-luxury" style="background: #1a1a1a; font-size: 0.8rem; text-decoration: none;">âš™ï¸ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                    <% } %>
                    <a href="/" class="btn-luxury" style="font-size: 0.8rem; text-decoration: none; border-color: #666; color: #666; background: none;">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
                    <a href="/logout" style="color: #d32f2f; font-size: 0.8rem; font-weight: 700; text-decoration: none; margin-top: 10px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ (ÄÄƒng xuáº¥t)</a>
                </div>
            </div>

            <div style="flex: 2; min-width: 350px;">
                <h3 style="font-family: 'Noto Serif JP'; border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 30px;">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š (CÃ i Ä‘áº·t tÃ i khoáº£n)</h3>
                
                <form id="profileForm">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 8px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼å (Username)</label>
                        <input type="text" name="username" value="<%= user.username %>" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 8px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (Email)</label>
                        <input type="email" name="email" value="<%= user.email %>" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 30px; position: relative;">
                        <label style="display: block; font-weight: 700; margin-bottom: 8px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (Password)</label>
                        <input type="password" id="passInput" value="<%= user.password %>" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #fdfdfd; color: #888;">
                        <span id="togglePass" style="position: absolute; right: 15px; top: 35px; cursor: pointer; font-size: 1.2rem;">ğŸ‘ï¸</span>
                    </div>

                    <div style="display: flex; gap: 15px;">
                        <button type="submit" class="btn-luxury" style="flex: 1;">ä¿å­˜ã™ã‚‹ (LÆ°u thay Ä‘á»•i)</button>
                        <button type="button" onclick="changePassword()" class="btn-luxury" style="flex: 1; background: none; color: var(--primary);">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
                    </div>
                </form>

                <div style="margin-top: 50px;">
                    <h4 style="font-family: 'Noto Serif JP'; margin-bottom: 20px; color: var(--primary);">ğŸŒŸ æœ€è¿‘ã®ãŠæ°—ã«å…¥ã‚Š</h4>
                    <div style="max-height: 250px; overflow-y: auto; padding-right: 10px;">
                        <% if (favoritesSafe.length > 0) { %>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                                <% favoritesSafe.forEach(place => { %>
                                    <div style="border: 1px solid #eee; padding: 10px; display: flex; align-items: center; gap: 15px; background: #fff; transition: 0.3s;">
                                        <img src="<%= place.imageUrl %>" style="width: 60px; height: 45px; object-fit: cover; border-radius: 2px;">
                                        <div style="flex: 1;">
                                            <h5 style="margin: 0; font-size: 0.9rem;"><%= place.name %></h5>
                                            <a href="/travel/<%= place.id %>" style="color: var(--accent); font-size: 0.75rem; text-decoration: none; font-weight: bold;">è©³ç´°ã‚’è¦‹ã‚‹ â†’</a>
                                        </div>
                                    </div>
                                <% }) %>
                            </div>
                        <% } else { %>
                            <p style="color: #999; font-size: 0.85rem; text-align: center;">ãŠæ°—ã«å…¥ã‚Šã®å ´æ‰€ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. áº¨n/Hiá»‡n máº­t kháº©u
        const togglePass = document.getElementById('togglePass');
        const passInput = document.getElementById('passInput');
        togglePass.addEventListener('click', () => {
            const type = passInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passInput.setAttribute('type', type);
            togglePass.innerText = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
        });

        // 2. Xá»­ lÃ½ cáº­p nháº­t thÃ´ng tin (AJAX)
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = e.target.username.value;
            const email = e.target.email.value;

            const res = await fetch('/profile/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}&email=${encodeURIComponent(email)}`
            });
            const data = await res.json();
            if(data.success) {
                alert("âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ (ÄÃ£ cáº­p nháº­t há»“ sÆ¡)");
            } else {
                alert("âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            }
        });

        // 3. Äá»•i máº­t kháº©u nhanh
        async function changePassword() {
            const newPass = prompt("æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (Nháº­p máº­t kháº©u má»›i):");
            if (newPass && newPass.length >= 6) {
                const res = await fetch('/profile/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `newPassword=${encodeURIComponent(newPass)}`
                });
                const data = await res.json();
                if(data.success) {
                    alert("âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼");
                    passInput.value = newPass;
                }
            } else if (newPass) {
                alert("âš ï¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            }
        }
    </script>
    
</body>
</html>